<!--
Copyright (c) Márk Csörgő and Martin Bartos
Licensed under the MIT License. See LICENSE file for details.
-->

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:avallama.ViewModels"
             xmlns:models="clr-namespace:avallama.Models"
             xmlns:services="clr-namespace:avallama.Services"
             xmlns:controls="clr-namespace:avallama.Controls"
             xmlns:converters="clr-namespace:avallama.Converters"
             xmlns:templatedControls="clr-namespace:avallama.Styles.TemplatedControls"
             xmlns:utilities="clr-namespace:avallama.Utilities"
             Background="{DynamicResource Surface}"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="avallama.Views.HomeView"
             x:DataType="vm:HomeViewModel"
             utilities:ViewInitialization.Command="{Binding InitializeAsync}">

    <UserControl.Resources>
        <converters:GenerationSpeedConverter x:Key="GenerationSpeedConverter" />
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" x:Name="MainGrid">

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300" MinWidth="250" MaxWidth="425" />
            <ColumnDefinition Width="8" />
            <ColumnDefinition Width="50" />
            <ColumnDefinition Width="7*" />
        </Grid.ColumnDefinitions>

        <!-- SideBar -->
        <Grid Grid.Column="0" Grid.Row="0" Grid.RowSpan="4" x:Name="SideBar" SizeChanged="SideBar_OnSizeChanged"
              RowDefinitions="Auto,*,Auto"
              Background="{DynamicResource SurfaceContainer}">
            <Grid Grid.Row="0" ColumnDefinitions="2.5*, 6*" x:Name="SideBarTopGrid">

                <!-- New conversation button -->
                <Button Grid.Column="0" x:Name="NewConversationBtn" Classes="avallamaWhite"
                        Content="{services:LocalizationService Key='NEW'}" FontWeight="Bold"
                        Margin="0,0,14,0" HorizontalAlignment="Stretch" Cursor="Hand"
                        IsEnabled="True" Command="{Binding CreateNewConversation}" />

                <!-- Conversation searchbar -->
                <TextBox Grid.Column="1" Watermark="{services:LocalizationService Key='SEARCH'}" MaxLines="1"
                         Background="{DynamicResource SurfaceContainerHighest}">
                    <TextBox.InnerRightContent>
                        <controls:DynamicSvg Path="/Assets/Svg/search.svg" Width="16"
                                             Margin="0,0,10,0" StrokeColor="{DynamicResource Primary}" />
                    </TextBox.InnerRightContent>
                </TextBox>

            </Grid>

            <!-- Conversation elements -->
            <ScrollViewer Grid.Row="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Margin="14">
                <ItemsControl ItemsSource="{Binding Conversations}" VerticalAlignment="Stretch">
                    <ItemsControl.DataTemplates>
                        <DataTemplate DataType="models:Conversation">
                            <templatedControls:ConversationItem
                                Id="{Binding ConversationId}"
                                SelectedId="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=((vm:HomeViewModel)DataContext).SelectedConversation.ConversationId}"
                                Command="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=((vm:HomeViewModel)DataContext).SelectConversation}"
                                Text="{Binding Title}"
                                SubText="{Binding Model}"
                                Margin="0,0,0,14">

                                <!-- DeletePopup that appears at right click -->
                                <templatedControls:ConversationItem.ContextFlyout>
                                    <controls:DeletePopup>
                                        <Button
                                            Content="{services:LocalizationService Key='DELETE'}"
                                            Command="{Binding $parent[UserControl].((vm:HomeViewModel)DataContext).DeleteConversation}"
                                            CommandParameter="{Binding ConversationId}"
                                            Classes="errorButton"
                                            BorderBrush="{DynamicResource Error}"
                                            BorderThickness="1"
                                            Foreground="{DynamicResource OnError}"
                                            HorizontalAlignment="Center"
                                            Padding="12,6" />
                                    </controls:DeletePopup>
                                </templatedControls:ConversationItem.ContextFlyout>

                            </templatedControls:ConversationItem>
                        </DataTemplate>
                    </ItemsControl.DataTemplates>
                </ItemsControl>
            </ScrollViewer>

            <StackPanel Grid.Row="2" Margin="10" Orientation="Horizontal" Spacing="16" HorizontalAlignment="Left">

                <!-- Settings button -->
                <Button Classes="clearButton" Cursor="Hand"
                        Command="{Binding Path=((vm:MainViewModel)DataContext).OpenSettings, RelativeSource={RelativeSource AncestorType=Window}}">
                    <controls:DynamicSvg
                        Path="/Assets/Svg/settings.svg" Width="24" FillColor="{DynamicResource Primary}" />
                </Button>

                <!-- ModelManager button -->
                <Button Classes="clearButton"
                        Command="{Binding Path=((vm:MainViewModel)DataContext).OpenModelManager, RelativeSource={RelativeSource AncestorType=Window}}"
                        Cursor="Hand">
                    <controls:DynamicSvg
                        Path="/Assets/Svg/model-manager.svg" Width="28"
                        FillColor="{DynamicResource Primary}" />
                </Button>

            </StackPanel>
        </Grid>

        <!-- GridSplitter that can resize columns -->
        <GridSplitter Grid.Row="0" Grid.RowSpan="4" Grid.Column="1" x:Name="GridSplitter" Opacity="0"
                      ResizeDirection="Columns" />

        <!-- SideBar expand/hide button -->
        <Button Grid.Row="0" Grid.Column="2" x:Name="SideBarButton" Classes="clearButton"
                Click="SideBarBtn_OnClick" Cursor="Hand">
            <controls:DynamicSvg
                Path="/Assets/Svg/sidebar.svg" Width="20" FillColor="{DynamicResource Primary}" />
        </Button>

        <StackPanel Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3" Orientation="Horizontal"
                    HorizontalAlignment="Center" Margin="0,20,0,0" Spacing="14">

            <!-- Model chooser ComboBox -->
            <ComboBox Width="175"
                      VerticalAlignment="Center"
                      ItemsSource="{Binding AvailableModels}"
                      SelectedItem="{Binding SelectedModelName, Mode=TwoWay}"
                      IsEnabled="{Binding IsModelsDropdownEnabled}" x:Name="ModelsComboBox" />
        </StackPanel>

        <!-- Informational messages -->
        <StackPanel Grid.Column="1" Grid.ColumnSpan="3" Grid.Row="1" Orientation="Vertical" Margin="18,10,18,0"
                    HorizontalAlignment="Stretch" VerticalAlignment="Center" Spacing="6"
                    IsVisible="{Binding ShowInformationalMessages}">

            <!-- There are many Grids because this is the way to ensure that the TextBlock inside them
            is not cut off, but instead trims its end with an ellipsis (CharacterEllipsis). More precisely,
            by specifying the column width with *, the TextBlock is able to trim its text properly. -->

            <!-- Remote ollama connection text -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="6" HorizontalAlignment="Center"
                  IsVisible="{Binding IsRemoteConnectionTextVisible}">
                <Ellipse Grid.Column="0" Width="12" Height="12" Fill="{DynamicResource Success}" />

                <TextBlock Grid.Column="1" Text="{Binding RemoteConnectionText}"
                           Foreground="{DynamicResource Success}"
                           TextAlignment="Left"
                           TextTrimming="CharacterEllipsis" />
            </Grid>

            <!-- Low VRAM text -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="4" HorizontalAlignment="Center"
                  IsVisible="{Binding IsResourceWarningVisible}">
                <controls:DynamicSvg Grid.Column="0" Path="/Assets/Svg/info.svg"
                                     FillColor="{DynamicResource Error}"
                                     Width="18" />

                <TextBlock Grid.Column="1" Text="{Binding ResourceLimitWarning}"
                           Foreground="{DynamicResource Error}"
                           TextAlignment="Left"
                           TextTrimming="CharacterEllipsis" />
            </Grid>

            <!-- Model is not downloaded text -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="4" HorizontalAlignment="Center"
                  IsVisible="{Binding IsNoModelsWarningVisible}">
                <controls:DynamicSvg Grid.Column="0" Path="/Assets/Svg/info.svg"
                                     FillColor="{DynamicResource Error}"
                                     Width="18" />

                <TextBlock Grid.Column="1" Text="{Binding NoModelsDownloadedWarning}"
                           Foreground="{DynamicResource Error}"
                           TextAlignment="Left"
                           TextWrapping="Wrap"
                           x:Name="NoModelsWarningTextBlock" />
            </Grid>
        </StackPanel>

        <Grid Grid.Column="1" Grid.Row="2" ColumnSpan="3" RowDefinitions="*,Auto" Margin="18,0">

            <!-- Restart Ollama (if it's unable to connect)  -->
            <StackPanel x:Name="RetryPanel" Grid.Row="0" Orientation="Vertical" VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Spacing="12" ZIndex="10" Margin="40, 0" IsVisible="{Binding IsRetryPanelVisible}">

                <!-- Error message -->
                <TextBlock
                    x:Name="RetryInfoText"
                    Text="{Binding RetryInfoText}"
                    TextAlignment="Center"
                    FontSize="14" Foreground="{DynamicResource OnSurface}" TextWrapping="Wrap" />

                <!-- Retry button -->
                <Button x:Name="RetryButton"
                        Content="{services:LocalizationService Key='RETRY'}"
                        Padding="14, 4" CornerRadius="6"
                        Command="{Binding RetryOllamaConnection}"
                        Cursor="Hand" HorizontalAlignment="Center" VerticalAlignment="Center"
                        IsVisible="{Binding IsRetryButtonVisible}" />
            </StackPanel>

            <!-- Messages of the selected conversation -->
            <Grid x:Name="ConversationGrid" Grid.Row="0" HorizontalAlignment="Stretch" Margin="0, 15, 0, 0"
                  IsVisible="{Binding !IsRetryPanelVisible}">
                <ScrollViewer ScrollChanged="ScrollViewer_OnScrollChanged" x:Name="ConversationScrollViewer">
                    <ItemsControl ItemsSource="{Binding SelectedConversation.Messages}">

                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical" Spacing="20" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.DataTemplates>

                            <!-- Specific message types need to be defined first, so the base Message type won't catch all -->
                            <DataTemplate DataType="models:FailedMessage">
                                <templatedControls:MessageItem />
                            </DataTemplate>

                            <DataTemplate DataType="models:GeneratedMessage">
                                <templatedControls:MessageItem
                                    Classes="generatedMessage"
                                    Text="{Binding Content}"
                                    SubText="{Binding Path=GenerationSpeed, Converter={StaticResource GenerationSpeedConverter}}" />
                            </DataTemplate>

                            <DataTemplate DataType="models:Message">
                                <templatedControls:MessageItem
                                    Classes="userMessage"
                                    Text="{Binding Content}" />
                            </DataTemplate>

                        </ItemsControl.DataTemplates>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Scroll to bottom button with a shadow -->
                <Border Width="40" Height="40" x:Name="ScrollToBottomBtnShadow"
                        Background="Transparent"
                        CornerRadius="24"
                        IsVisible="False"
                        HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,-3" />
                <Button x:Name="ScrollToBottomBtn" IsVisible="False" Classes="clearButton" Cursor="Hand"
                        Click="ScrollToBottomBtn_OnClick" HorizontalAlignment="Center" VerticalAlignment="Bottom"
                        Margin="0,0,0,-5">
                    <Border Padding="4" Background="{DynamicResource Primary}" CornerRadius="24">
                        <controls:DynamicSvg
                            Path="/Assets/Svg/arrow-down.svg" Width="40" FillColor="{DynamicResource OnPrimary}" />
                    </Border>
                </Button>

            </Grid>

            <!-- Send message button -->
            <TextBox Grid.Row="1"
                     x:Name="MessageTextBox"
                     Watermark="{services:LocalizationService Key='SEND_MESSAGE'}"
                     Margin="0,30,0,20"
                     Padding="20, 10"
                     IsEnabled="{Binding IsMessageBoxEnabled}"
                     Text="{Binding NewMessageText, Mode=TwoWay}">
                <TextBox.KeyBindings>
                    <KeyBinding Gesture="Enter"
                                Command="{Binding SendMessageCommand}" />
                </TextBox.KeyBindings>
            </TextBox>
        </Grid>
    </Grid>
</UserControl>
