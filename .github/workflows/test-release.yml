name: Release Avallama (Test)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (without v prefix)'
        required: true
        default: '0.0.1'

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_NOLOGO: "true"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"

permissions:
  contents: read

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
    permissions:
      contents: read
      id-token: write
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
      DOTNET_NOLOGO: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Display dotnet info
        run: dotnet --info

      - name: Restore
        run: dotnet restore avallama.sln

      - name: Build
        run: dotnet build avallama.sln --configuration Release --no-restore

      - name: Test
        run: >-
          dotnet test avallama.sln
          --configuration Release
          --no-build
          --settings avallama.Tests/runsettings.runsettings
          --logger "console;verbosity=detailed"
          -v n

  build-windows:
    name: Build Windows Installer (.exe)
    needs: test
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'

      - name: Set version var
        run: |
          "VERSION=${{ github.event.inputs.version }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Restore & Publish
        run: dotnet publish avallama/avallama.csproj -c Release -r win-x64 --self-contained true -o win-dist /p:PublishSingleFile=true

      - name: Install Inno Setup
        run: |
          Invoke-WebRequest https://jrsoftware.org/download.php/is.exe -OutFile is.exe
          Start-Process -FilePath .\is.exe -ArgumentList '/VERYSILENT', '/SUPPRESSMSGBOXES' -Wait
          echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH

      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAppVersion="${env:VERSION}" `
            scripts\installer.iss

  build-debian:
    name: Build Debian Package (.deb)
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'

      - name: Set version var
        run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Run Debian packaging script
        run: |
          chmod +x scripts/package-debian.sh
          ./scripts/package-debian.sh "${{ env.VERSION }}"

  build-arch:
    name: Build Arch Package (.pkg.tar.zst)
    needs: test
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install base build tools and .NET
        run: |
          pacman -Syu --noconfirm
          pacman -Sy --noconfirm base-devel git curl unzip icu dotnet-sdk dotnet-runtime fontconfig freetype2 libx11 libxrender libxcb mesa libpng zlib
          dotnet --version

      - name: Checkout source
        uses: actions/checkout@v6

      - name: Set version var
        run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Run Arch packaging script
        run: |
          useradd -m builder
          mkdir -p /tmp/build
          cp -r avallama /tmp/build/
          cp -r scripts /tmp/build/
          chown -R builder:builder /tmp/build
          sudo -u builder bash -c "cd /tmp/build && chmod +x scripts/package-arch.sh && scripts/package-arch.sh '${{ env.VERSION }}'"


  build-macos:
    name: Build macOS Packages (.dmg for x64 and arm64)
    needs: test
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'

      - name: Install create-dmg tool
        run: brew install create-dmg

      - name: Set version var
        run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Run macOS packaging script
        run: |
          chmod +x scripts/package-macos.sh
          ./scripts/package-macos.sh "${{ env.VERSION }}"
